<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Flag Analysis Viewer</title>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.dataTables.min.css">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #file-input {
            margin-bottom: 20px;
            padding: 10px;
            border: 2px dashed #ccc;
            border-radius: 4px;
            background: #fafafa;
        }

        #file-input:hover {
            border-color: #999;
        }

        table.dataTable {
            width: 100% !important;
        }

        table.dataTable thead th {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        /* Column filter inputs */
        table.dataTable thead tr.filters th {
            padding: 8px;
        }

        table.dataTable thead tr.filters input,
        table.dataTable thead tr.filters select {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Severity score coloring */
        .severity-high {
            background-color: #f8d7da !important;
            color: #721c24;
            font-weight: bold;
        }

        .severity-medium {
            background-color: #fff3cd !important;
            color: #856404;
        }

        .severity-low {
            background-color: #d4edda !important;
            color: #155724;
        }

        /* Red flags badges */
        .red-flag-badge {
            display: inline-block;
            padding: 2px 6px;
            margin: 2px;
            background: #dc3545;
            color: white;
            border-radius: 3px;
            font-size: 11px;
        }

        /* Content preview */
        .content-preview {
            max-width: 300px;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 12px;
            color: #666;
        }

        /* URL link */
        .url-link {
            color: #007bff;
            text-decoration: none;
            font-size: 12px;
        }

        .url-link:hover {
            text-decoration: underline;
        }

        /* Stats bar */
        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 4px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Red Flag Analysis Viewer</h1>

        <div id="file-input">
            <label for="csv-file">Load CSV file: </label>
            <input type="file" id="csv-file" accept=".csv">
        </div>

        <div id="stats-bar" class="stats-bar" style="display: none;">
            <div class="stat-item">
                <div class="stat-value" id="total-count">0</div>
                <div class="stat-label">Total Regulations</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="flagged-count">0</div>
                <div class="stat-label">With Red Flags</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="high-severity-count">0</div>
                <div class="stat-label">High Severity (9-10)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="medium-severity-count">0</div>
                <div class="stat-label">Medium Severity (7-8)</div>
            </div>
        </div>

        <table id="red-flags-table" class="display" style="width:100%; display: none;">
            <thead>
                <tr class="filters">
                    <th>Source Index</th>
                    <th>Title</th>
                    <th>URL</th>
                    <th>Content</th>
                    <th>Red Flags</th>
                    <th>Severity</th>
                </tr>
                <tr>
                    <th>Source Index</th>
                    <th>Title</th>
                    <th>URL</th>
                    <th>Content</th>
                    <th>Red Flags</th>
                    <th>Severity</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        let dataTable = null;

        // Parse red flags from string representation
        function parseRedFlags(flagsStr) {
            if (!flagsStr || flagsStr === '[]') return [];
            try {
                // Handle Python list format
                const cleaned = flagsStr.replace(/'/g, '"');
                return JSON.parse(cleaned);
            } catch (e) {
                return [];
            }
        }

        // Format red flags as badges
        function formatRedFlags(flags) {
            if (!flags || flags.length === 0) return '<span style="color:#999">None</span>';
            return flags.map(flag =>
                `<span class="red-flag-badge">${flag.replace(/_/g, ' ')}</span>`
            ).join(' ');
        }

        // Get severity class
        function getSeverityClass(score) {
            if (score >= 9) return 'severity-high';
            if (score >= 7) return 'severity-medium';
            return 'severity-low';
        }

        // Initialize DataTable with data
        function initializeTable(data) {
            // Update stats
            const total = data.length;
            const flagged = data.filter(r => parseRedFlags(r.red_flags).length > 0).length;
            const highSeverity = data.filter(r => parseInt(r.severity_score) >= 9).length;
            const mediumSeverity = data.filter(r => {
                const score = parseInt(r.severity_score);
                return score >= 7 && score < 9;
            }).length;

            document.getElementById('total-count').textContent = total;
            document.getElementById('flagged-count').textContent = flagged;
            document.getElementById('high-severity-count').textContent = highSeverity;
            document.getElementById('medium-severity-count').textContent = mediumSeverity;
            document.getElementById('stats-bar').style.display = 'flex';

            // Prepare table data
            const tableData = data.map(row => {
                const flags = parseRedFlags(row.red_flags);
                const severity = parseInt(row.severity_score) || 0;

                return [
                    row.source_index,
                    row.title || '',
                    row.url || '',
                    row.content || '',
                    flags,
                    severity
                ];
            });

            // Destroy existing table if it exists
            if (dataTable) {
                dataTable.destroy();
            }

            // Show table
            document.getElementById('red-flags-table').style.display = 'table';

            // Initialize DataTable
            dataTable = $('#red-flags-table').DataTable({
                data: tableData,
                columns: [
                    { title: 'Source Index', width: '80px' },
                    { title: 'Title', width: '200px' },
                    {
                        title: 'URL',
                        width: '100px',
                        render: function(data) {
                            if (!data) return '';
                            return `<a href="${data}" target="_blank" class="url-link">View</a>`;
                        }
                    },
                    {
                        title: 'Content',
                        width: '300px',
                        render: function(data) {
                            if (!data) return '';
                            const preview = data.substring(0, 200) + (data.length > 200 ? '...' : '');
                            return `<div class="content-preview" title="${data.replace(/"/g, '&quot;')}">${preview}</div>`;
                        }
                    },
                    {
                        title: 'Red Flags',
                        width: '200px',
                        render: function(data) {
                            return formatRedFlags(data);
                        }
                    },
                    {
                        title: 'Severity',
                        width: '80px',
                        render: function(data, type, row) {
                            if (type === 'display') {
                                return `<span class="${getSeverityClass(data)}" style="padding: 4px 8px; border-radius: 4px;">${data}</span>`;
                            }
                            return data;
                        }
                    }
                ],
                orderCellsTop: true,
                fixedHeader: true,
                pageLength: 25,
                order: [[5, 'desc']], // Sort by severity descending
                initComplete: function() {
                    // Add column filters
                    this.api().columns().every(function(index) {
                        const column = this;
                        const header = $(column.header()).closest('thead').find('tr.filters th').eq(index);

                        // Different filter types for different columns
                        if (index === 5) { // Severity - dropdown
                            const select = $('<select><option value="">All</option></select>')
                                .appendTo(header.empty())
                                .on('change', function() {
                                    const val = $.fn.dataTable.util.escapeRegex($(this).val());
                                    column.search(val ? '^' + val + '$' : '', true, false).draw();
                                });

                            // Add severity options
                            for (let i = 0; i <= 10; i++) {
                                select.append(`<option value="${i}">${i}</option>`);
                            }
                        } else if (index === 4) { // Red Flags - multi-select style
                            const select = $('<select><option value="">All</option></select>')
                                .appendTo(header.empty())
                                .on('change', function() {
                                    const val = $(this).val();
                                    column.search(val, false, false).draw();
                                });

                            // Collect unique red flags
                            const allFlags = new Set();
                            data.forEach(row => {
                                parseRedFlags(row.red_flags).forEach(flag => allFlags.add(flag));
                            });

                            Array.from(allFlags).sort().forEach(flag => {
                                select.append(`<option value="${flag}">${flag.replace(/_/g, ' ')}</option>`);
                            });
                        } else if (index !== 2 && index !== 3) { // Text search for other columns (not URL or content)
                            $('<input type="text" placeholder="Search..." />')
                                .appendTo(header.empty())
                                .on('keyup change', function() {
                                    if (column.search() !== this.value) {
                                        column.search(this.value).draw();
                                    }
                                });
                        } else {
                            header.empty(); // Clear URL and content filter headers
                        }
                    });
                }
            });
        }

        // Handle file upload
        document.getElementById('csv-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        initializeTable(results.data);
                    }
                },
                error: function(error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            });
        });
    </script>
</body>
</html>
